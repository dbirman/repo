

### QUESTION 3

30 people were randomly assigned to two different diets (low-fat and not low-fat) and three different types of exercise (at rest, walking leisurely and running). Their pulse rate was measured at three different time points during their assigned exercise (at 1 minute, 15 minutes and 30 minutes).


Fields:

  id: Subject ID
  diet: 1 = low fat; 2 = not low fat
  exertype: 1 = at rest, 2 = walking, 3 = running
  pulse
  time: 1 = 1 min, 2 = 15 min, 3 = 30 min

```{r}
data = read.csv("http://web.stanford.edu/class/psych252/_downloads/exer.csv")
data$exertypef = factor(data$exertype,levels=c(1,2,3),labels=c("Rest","Leisure","Running"))
data$dietf = factor(data$diet,levels=c(1,2),labels=c("Low-Fat","Not Low-Fat"))
```

Let's take a look at the data. We might first wonder whether the change in pulse rate over time depended on individual diets. Note that because the individual subjects are not of interest we should treat variability across subjects as a random effect.

Note: Time is a *roughly* quantitative variable, corresponding more or less to 15 minute intervals, we'll just look at it in this way.

```{r}
rs1 = lmer(pulse ~ time + dietf + (1|id),data)
rs2 = lmer(pulse ~ time * dietf + (1|id),data)
ggplot(data) +
  geom_point(aes(time,pulse,color=dietf)) +
  geom_smooth(aes(time,pulse,color=dietf),method="lm",formula=y~x+x^2) +
  theme_bw()
ggplot(data) +
  geom_line(aes(time,pulse,color=dietf,group=id)) +
  theme_bw()
```

It looks like modeling the random effect is a good idea, a small number of subjects appear to show outlier behavior, in that their slope is much steeper than the majority of the subjects. The first graph hints that there may be an additive effect of diet on time, since the slopes don't appear to change much. Let's test this:

```{r}
anova(rs1,rs2)
```

As we expected the interaction doesn't add anything significant, *p* = .136.

```{r}
summary(rs1)
```

We computed a linear mixed effects regression model predicting pulse rate from time, diet, and subject (as a random effect). We found that time was a significant predictor of pulse rate, with increasing pulse rate over time, and that there was a marginal effect of diet, where low-fat diets resulted in lower pulse rates compared to the non low-fat diets.

Buuuuuuut, this all makes no sense, if some of the participants were not doing the same exercise. Good thing we have that in our data set. Let's repeat the exact same analysis but look at just the effect of exercise.

```{r}
rs3 = lmer(pulse ~ time + exertypef + (1|id),data)
rs4 = lmer(pulse ~ time * exertypef + (1|id),data)
ggplot(data) +
  geom_point(aes(time,pulse,color=exertypef)) +
  geom_smooth(aes(time,pulse,color=exertypef),method="lm",formula=y~x+x^2) +
  theme_bw()
ggplot(data) +
  geom_line(aes(time,pulse,color=exertypef,group=id)) +
  theme_bw()
```

The plots make it abundantly clear that there might be an interaction, even when accounting for individual subject variability.

```{r}
anova(rs3,rs4)
```

Interaction! Yay FYP!

```{r}
summary(rs4)
```

We computed a mixed effects regression predicting pulse from both time of measurement and exercise type, and found that there was a significant interaction, such that for the running group the effect of time is a positive linear relationship, $\beta_{time:exertypefRunning} = 14.35, t = 6.66, p < .001$ but, all of the other groups show no significant effects.

We've now seen that running was causing all of the observed increase. Let's go back and re-consider our position about diet. Perhaps diet has different effects in the different categories, or has an effect only on runners. Let's take a look to see whether this might be true.

```{r}
rs5 = lmer(pulse ~ exertype + diet + time + (1|id),data)
rs6 = lmer(pulse ~ exertype * diet + time + (1|id),data)
rs7 = lmer(pulse ~ exertype * diet * time + (1|id),data)
ggplot(data) +
  geom_point(aes(time,pulse,color=dietf)) + 
  geom_smooth(aes(time,pulse,color=dietf),method="lm",formula=y~x+x^2) +
  facet_grid(.~exertypef) +
  theme_bw()
```

The graph suggests that there is a three way interaction between the fixed effects. Specifically, pulse rate only depends on time during the running exercise and the strength of the effect (slope) depends on diet. No other effects appear to be significant (i.e. in both the rest and leisure facets, there are no significant differences). We computed an anova first to test that the interaction model is the best fit given the increased number of degrees of freedom:

```{r}
anova(rs5,rs6,rs7)
```

Yes, the three way interaction model fits best, as it has the lowest AIC value.

```{r}
summary(rs7)
```

As we expected, the three way interaction is significant, as well as a marginal interaction between diet and time, $\beta_{exertype:diet:time} = 6.25, t = 2.90, p = .005$, $\beta_{diet:time} = -8.93, t = -1.92, p = .060$. Note that our previous model showed an time:exercise effect, so that was expected.

Whoops, now I realized I did things in the wrong order. Anyways, we'll look now at compound symmetry and unstructed covariance models and then go back and re-consider this result in light of the following findings: 

We now want to know whether the covariance across time points varies in predictable ways. Normally we assume that there is independence across time, so that each time point covaries with itself (variance), but has no covariance with other times. In our dataset, because the time points may be correlated with other time points across participants, we can take this into account by modeling a different covariance matrix.

The covariance matrices we will consider are:

Indep   Symmetric   Unstructured   
v 0 0    v a a       v a b
0 v 0    a v a       c v d
0 0 v    a a v       e f v

Let's look at our covariance structure and see what it looks like:

```{r}
cov_dat = with(data,matrix(c(pulse[time==1],pulse[time==2],pulse[time==3]),ncol=3))
covar = var(cov_dat)
covar
```

It doesn't look like our covariance structure is independent, it looks unstructured. Let's check whether this is true.

```{r}
library(nlme)
# Restructure data so that time is grouped by id
datag = groupedData(pulse ~ exertype * time | id, data)
#Unstructured
fit.un = gls(pulse ~ exertypef * time, datag, corr = corSymm(form = ~ 1 | id),
             weights=varIdent(form = ~ 1 | time))
#Compound Symmetric
fit.cs = gls(pulse ~ exertypef * time, datag, corr = corCompSymm(form = ~ 1 | id))
#Original
fit.i = gls(pulse ~ exertypef * time, data)
anova(fit.i,fit.cs,fit.un)
```

The anova suggests that the variance structure is probably unstructed, as we expected, not compound symmetric or independent, because that model fits the data best (based on the lowest AIC values).

We might consider now re-analyzing our results from above in light of this information. 
```{r}
fit.rs7 = gls(pulse ~ exertypef * diet * time, datag, corr = corSymm(form = ~ 1 | id),
             weights=varIdent(form = ~ 1 | time))
summary(rs7)
summary(fit.rs7)
```

Comparing the two models we see the same overall qualitative effects, but there is no longer a marginal effect of diet:time, which was suspect in the first place. That effect must have been observed because we didn't correctly account for the unstructured covariance across time within participants.

In summary, there is a three way interaction of diet, time, and exercise, with no other significant main effects. The effect of time on pulse shows unstructured covariance, such that across participants there is an inconsistent correlation in variance between time points (1/2/3). 
